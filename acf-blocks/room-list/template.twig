{% set f = fields ?? {} %}
{% set items = f.rooms ?? [] %}

<section class="room-list-block py-16 md:py-24 bg-gray-50">
	<div class="container mx-auto px-4 md:px-6 max-w-7xl">

		{% if f.title or f.subtitle %}
			{% include 'components/section-header.twig' with { title: f.title, text: f.subtitle } %}
		{% endif %}

		{% set rooms = [] %}
		{% for r in items %}
			{% if (r.room_type ?? '') and (r.photos is iterable and r.photos|length) %}
				{% set rooms = rooms|merge([r]) %}
			{% endif %}
		{% endfor %}

		{% if rooms|length %}
			{% set allPhotos = [] %}
			{% set photoIndex = 0 %}

			<div class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-12">
				{% for room in rooms %}
					<article class="w-full max-w-[382px] mx-auto flex flex-col h-full bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden border border-gray-100 group">
						<div class="relative aspect-[4/3] bg-gray-200 select-none overflow-hidden">
							<div class="carousel-track flex h-full w-full overflow-x-auto snap-x snap-mandatory no-scrollbar scroll-smooth [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
								{% for img in room.photos %}
									{% set src = img.url
                                                ?? (img.id ? function('wp_get_attachment_image_url', img.id, 'large') : null) %}
									{% if src %}
										{# on enrichit la liste globale et on assigne un index #}
										{% set allPhotos = allPhotos|merge([{
                                            src: img.url
                                                 ?? (img.id ? function('wp_get_attachment_image_url', img.id, 'full') : ''),
                                            alt: img.alt|default(room.room_type)
                                        }]) %}
										<img src="{{ src }}" loading="lazy" class="h-full w-full shrink-0 snap-center object-cover cursor-pointer" alt="{{ room.room_type }}" data-lightbox-index="{{ photoIndex }}">
										{% set photoIndex = photoIndex + 1 %}
									{% endif %}
								{% endfor %}
							</div>

							{% if room.photos|length > 1 %}
								<div class="hidden lg:flex absolute inset-0 items-center justify-between px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
									<button type="button" onclick="scrollTrack(this, -1)" class="pointer-events-auto h-8 w-8 rounded-full bg-white/90 text-gray-800 shadow-sm hover:bg-white flex items-center justify-center transition-transform hover:scale-105 focus:outline-none">
										<i class="fa-solid fa-chevron-left text-xs"></i>
									</button>
									<button type="button" onclick="scrollTrack(this, 1)" class="pointer-events-auto h-8 w-8 rounded-full bg-white/90 text-gray-800 shadow-sm hover:bg-white flex items-center justify-center transition-transform hover:scale-105 focus:outline-none">
										<i class="fa-solid fa-chevron-right text-xs"></i>
									</button>
								</div>
								<div class="absolute bottom-3 right-3 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm pointer-events-none">
									<i class="fa-regular fa-images mr-1"></i>
									{{ room.photos|length }}
								</div>
							{% endif %}
						</div>

						<div class="p-6 text-left flex flex-col grow">
							<div class="flex flex-wrap items-start justify-between gap-3 mb-3">
								<h3 class="text-xl md:text-2xl font-semibold mb-3 text-gray-900 line-clamp-1">
									{{ room.room_type }}
								</h3>
								{% if room.area_sqm|default(0) > 0 %}
									<span class="inline-flex items-center gap-1.5 rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 shrink-0">
										<i class="fa-solid fa-ruler-combined text-gray-400"></i>
										{{ room.area_sqm|number_format(0, '.', '') }}
										m²
									</span>
								{% endif %}
							</div>

							{% if room.description %}
								<p class="text-base md:text-lg text-gray-600 leading-relaxed mb-4 line-clamp-5">
									{{ room.description|nl2br }}
								</p>
							{% endif %}
						</div>
					</article>
				{% endfor %}
			</div>

			<div id="lightbox" class="fixed inset-0 z-[100] hidden bg-black/95 backdrop-blur-sm w-full h-full">

				<button id="lb-close" class="absolute top-6 right-6 md:top-8 md:right-8 text-white text-7xl z-[110] cursor-pointer hover:scale-110 transition-transform focus:outline-none leading-none p-2">&times;</button>

				<button id="lb-prev" class="absolute left-4 md:left-8 top-1/2 transform -translate-y-1/2 text-white text-7xl z-[110] cursor-pointer hover:scale-110 transition-transform focus:outline-none p-3">‹</button>

				<button id="lb-next" class="absolute right-4 md:right-8 top-1/2 transform -translate-y-1/2 text-white text-7xl z-[110] cursor-pointer hover:scale-110 transition-transform focus:outline-none p-3">›</button>

				<div class="flex items-center justify-center w-full h-full p-4 md:p-16 pointer-events-none">
					<img id="lb-img" src="" alt="" class="max-w-full max-h-full object-contain drop-shadow-2xl pointer-events-auto select-none"/>
				</div>

			</div>

			<script>
				window.rlLightboxPhotos = {{ allPhotos|json_encode|raw }};
			</script>
		{% endif %}
	</div>
</section>
